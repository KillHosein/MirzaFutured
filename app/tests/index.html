<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Mirza Pro Tests</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-white p-8">
    <h1 class="text-2xl font-bold mb-4">Unit Tests</h1>
    <div id="results" class="space-y-2"></div>

    <!-- Mocks -->
    <script>
        window.__APP_CONFIG__ = { apiUrl: 'http://localhost/api' };
        
        // Mock DOM elements
        document.body.innerHTML += `
            <div id="app-loading" class="hidden"></div>
            <div id="toast-container"></div>
            <div id="app-content"></div>
        `;
    </script>

    <!-- Test Runner -->
    <script type="module">
        import { API } from '../assets/js/modules/api.js';
        import { UI } from '../assets/js/modules/ui.js';

        const results = document.getElementById('results');
        
        function assert(condition, message) {
            const div = document.createElement('div');
            div.className = condition ? 'text-green-400' : 'text-red-400 font-bold';
            div.textContent = (condition ? 'PASS: ' : 'FAIL: ') + message;
            results.appendChild(div);
            return condition;
        }

        async function runTests() {
            // Test 1: UI Formatting
            assert(UI.formatMoney(1000).includes('تومان'), 'UI.formatMoney should add currency');
            
            // Test 2: API Token Management
            API.setToken('test-token');
            assert(API.token === 'test-token', 'API.setToken should set token');
            assert(localStorage.getItem('app_token') === 'test-token', 'API.setToken should persist to localStorage');
            
            // Test 3: API Caching Key Generation (Internal logic check)
            // We can't access private scope, but we can check if cache is populated after request
            // Mock fetch
            const originalFetch = window.fetch;
            window.fetch = async () => ({
                ok: true,
                status: 200,
                json: async () => ({ status: true, msg: 'ok', obj: [] })
            });

            await API.request('test_action', 'GET', { id: 1 }, true);
            const cacheKey = 'test_action_' + JSON.stringify({ id: 1 });
            assert(API.cache[cacheKey] !== undefined, 'API should cache GET requests when useCache is true');
            
            // Restore fetch
            window.fetch = originalFetch;

            // Test 4: UI Toast
            UI.toast('Test Message', 'success');
            const toast = document.querySelector('.toast');
            assert(toast !== null, 'UI.toast should create a toast element');
            assert(toast.textContent.includes('Test Message'), 'Toast should contain message');
        }

        runTests().catch(err => {
            const div = document.createElement('div');
            div.className = 'text-red-500';
            div.textContent = 'ERROR: ' + err.message;
            results.appendChild(div);
        });
    </script>
</body>
</html>